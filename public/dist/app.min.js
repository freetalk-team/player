!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var a=t();for(var i in a)("object"==typeof exports?exports:e)[i]=a[i]}}(self,(()=>(()=>{"use strict";var e={d:(t,a)=>{for(var i in a)e.o(a,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:a[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{PlayerApp:()=>k});const a={async executeCommand(e,t,a,...i){const s=e.split("-");s.length>1&&(e=s.shift(),t&&(a&&i.unshift(a),a=t),t=s.shift(),s.length>0&&(a&&i.unshift(a),a=s.shift()),i.unshift(...s));const o=[e,t,a].filter((e=>!!e)).join("-");if(this.handleCommand(o,...i))return;if("edit"==e||"add"==e&&"new"==t){let s,o=!1;"edit"==e&&(s=a,a=t,t="update",o=!0);const n={};let r;if("profile"==a?n.info={name:app.displayName,status:app.status,photo:app.avatar}:i.length>0&&(r=i[0],"string"==typeof r&&(s=r)),s){let e=app.ds(a);if(e&&(r=await e.get(s),o&&"scraper"===a)&&!r.code&&(e=app.ds("code"),e)){console.debug("Pulling code from database");try{const t=(await e.get(s)).content;r.code="string"==typeof t?t:unzip(t)}catch(e){console.error("Scraper code not exists:",s)}}}return r&&(n.info=r),Object.assign(n,{async onAdd(i){if(s&&(i.id=s),"add"==e&&"task"===a&&(i.ts=Date.seconds()),i.user=app.uid||"admin",await app.add(a,i,t),i.id){if("task"===a)return app.openEditor("support","task",i.id,!0);app.cancelEditor()}}}),o?(n.reload=!0,this.openEditor("add","edit",a,n)):this.openEditor(e,t,a,n)}let n=i.pop();switch(e){case"share":return this.share(a,n,...i);case"find":return this.find(a);case"add":return this.add(a,n);case"join":return n=a,a=t,console.debug("Joining",a,"=>",n),this.add(a,n,"import");case"help":if(console.log("Openning help editor"),"editor"===a){const e=this.editor.currentEditor;if(e){const t=e.type;return this.openEditor("wiki","wiki",t)}}return;case"task":return this.openEditor("support","task",a);case"player":switch(t){case"file":return this.player.playFile(a);case"radio":return this.player.playRadio(n,a)}case"import":{const e=this.ds(t),i=this.ds(a);if("torrent"==t&&n.startsWith("magnet:")){const{hash:e}=parseMagnetURI(n);n=e}const s=function(e,t){return"torrent"===e&&"playlist"===t?e=>Object({id:e.id,genre:e.genre||"pop",display:e.title,name:e.title.toLowerCase(),tracks:e.files,torrent:e.uri}):e=>e}(t,a);let o=await e.get(n);o=s(o),await i.put(o),app.emit(`${a}add`,o)}return;case"rm":{n=n||a,a=t;const e=this.ds(a);await e.rm(n),app.emit(`${a}rm`,n)}return;case"purge":{n=a,a=t;const e=this.ds(a);await e.purge(n),app.emit(`${a}rm`,n)}return;case"pin":{const e=await app.ds(a).get(n);if(e){const{id:t,channel:i,content:s,ts:o,user:n}=e;this.add("pin",{id:t,channel:i,content:s,ts:o,user:n,type:a})}}return;case"select":if("channel"===t)switch(a){case"scraper":{const e=`data/scraper/${n}/scrapers`,t=await app.firebase.ls(e)||{};console.debug("Scrapers for channel",n,t);const a={icon:"fa-scissors",title:"Edit scrapers",desc:"Add or remove channel scrapers",ds:"scraper",type:"select",force:!0,isselected:e=>!!t[e.id],ondone:async e=>{console.log("Channel scrapers:",e);const t={channel:n,scrapers:e.map((e=>e.id))};try{await ajax.post("/channel/scrapers",t),console.debug("Scrapers updated successfully")}catch(e){console.error("Failed to update scrapers")}}};app.openEditor("find","scraper",a)}break;case"admin":{const e={title:this.name,desc:"Add or remove channel admin users",ds:"contact",type:"select",force:!0,isselected:e=>!!this.admins&&this.admins[e.id],ondone:async e=>{console.log("Channel permision change",e),this.admins;try{const t={};for(const a of e)t[a]=!0;await app.db.update("channel",this.channel,{admins:t}),await app.firebase.update(this.adminPath,t),this.admins=t}catch(e){console.error("Failed to updates channel admins",e)}}};app.openEditor("find","channel-admin",e)}break;default:console.error("CMD: Invalid select channel:",a)}else console.error("CMD: Invalid select:",t);return;case"follow":"channel"===t&&(console.log("CMD: Subcribing for channel:",n),app.subscribe(n));break;case"open":return this.openEditor(a,t,...i,n)}}},i={chat:[],channel:[],comment:[],post:[],player:[],game:[]},s={async loadRecent(){const e=localStorage.getItem(this.recentPath),t=e?JSON.parse(e):i,a=[];for(const e of a)e.channel&&(getPostInfo(e),"string"==typeof e.channel&&(e.channel=await this.loadChannel(e.channel)),e.link&&(e.id=e.link.hashCode().toString()));t.post=a;const s=Date.seconds(),n=await this.db.lsByRange("recent","latest",["chat",0],["chat",s],!0);for(const e of n)await this.loadContact(e);t.chat=n;const r=await async function(){app.ds("comment",!0);const e=await app.db.lsByRange("recent","latest",["comment",0],["comment",Date.seconds()],!0);let t,a=[];for(const i of e){t=i.channel;const e=await app.db.get("comment",i.id),s=await app.db.lsByIndex("comment","topic",[t,i.gid]);console.debug("Loaded childs:",s),e.childs=s,await o(i),await o(e);for(const e of s)await o(e);a.push(e)}return a}();t.comment=r;const l=t.game;for(const e of l)await this.loadContact(e);return this._recent=t,t},async addRecent(e,t){}};async function o(e){await app.loadContact(e),e.channel=await app.loadChannel(e.channel),e.canreply=function(){return!this.own&&this.level<2}}const n="audio",r="playlist";class l extends App.Database{get version(){return 1}onUpgrade(e,t,a){0===a&&(l.addTable(e,"settings"),l.addTable(e,n),l.addTable(e,"radio"),l.addTable(e,r),l.addIndex(n,"rating",t),l.addIndex(n,"type",t),l.addIndex(n,"ts",t),l.addIndex(r,"type",t))}}class d extends App.Editor.Sidebar{static getTabs(){return[{name:"recent",icon:"fa-clock"}]}#e;#t;#a;get tabs(){return d.getTabs().map((e=>e.name.toLowerCase()))}constructor(e){super(e,"sidebar-player"),this.loadTabs();const t=this.getPage("recent"),a={visible:100,badge:!0,hide:!0,cmd:"player-play-file",icon:"fac-queue",name:"queue",item:"editor-player-sidebar-queue-item",actions:[{name:"clear"}]};this.#t=t.addGroup(a),a.icon="fac-play-recent",a.name="recent",a.item="editor-player-sidebar-playlist-file",a.actions=[{name:"add",cmd:"add-new-playlist"},{name:"clear"}],this.#a=t.addGroup(a),app.on("trackqueued",(e=>this.#i(e.detail))),app.on("trackchange",(e=>this.#s(e.detail)))}handleAction(e,t,a){console.debug("Sidebar player on action:",e),"clear"===e&&(app.player.clear(),this.#a.clear())}async#i(e){const t=Array.isArray(e)?e:[e];let a;for(const i of t)a=i,"object"!=typeof a&&(a=await app.db.get("audio",e)),a.title=a.title||fileX.getTitle(a),this.#t.add(a)}#s(e){const t=e.id;if(this.#t.delete(t),t!=this.#e){const a=this.#a.getElement(t);if(a)dom.moveTop(a);else{e.title||(e.title=fileX.getTitleFromMeta(e));const t=e.meta;!e.album&&t.album&&(e.album=t.year?`${t.album} - ${t.year}`:t.album),this.#a.add(e,!0)}}this.#e=t}}class c extends UX.Page{#o;get area(){return this.#o}constructor(e,t,a="editor-player-content-base"){const i=dom.renderTemplate(a,{});i.classList.add(t,"hidden"),e&&e.appendChild(i),super(i),this.#o=i.querySelector('[role="main"]')}load(){}search(){}onClick(){}onInput(){}onAction(){}onFilesDrop(){}onTabChange(){}onTrackChange(){}onTrackStop(){}}Object.assign(c.prototype,UX.ListMixin);class p extends c{static id="files";#n=0;#r=0;#l;#d=!1;get more(){return this.#d}constructor(e){super(e,p.id),app.on("audioadd",(e=>this.#c(e.detail)))}open(e){const t=this.container;e?(t.setAttribute("playlist",""),this.loadPlaylist(e.tracks)):t.removeAttribute("playlist")}async load(e=!1){e||(this.#n=0,this.#r=await app.db.count("audio"));const t=await app.db.lsByRating("audio",this.#n);return this.loadFiles(t)}loadFiles(e){console.log("PLAYER ED: Loading files: ",this.#n,e.length,this.#r),this.#n+=e.length,this.#d=e.length>=50;for(const t of e)this.#p(t);if(this.sort(h),app.player.isPlaying){const e=app.player.current;let t=this.getElementBy("id",e.id);t||(t=this.#p(e,!0)),t.classList.add("playing"),this.#l=e.id}}async loadPlaylist(e){const t=this.getElementsBy("playlist","true");for(const e of t)delete e.dataset.playlist;for(const t of e){let e=this.getElement(t.id);e||(e=this.#p(t)),e.dataset.playlist=!0}}onAction(e,t,a){if("delete"===e)return dom.removeElement(a),app.db.rm("audio",parseInt(t))}onInput(e){"filter"===e.name&&this.filterFields(e.value,"title","desc")}onTrackChange(e){let t;if(console.debug("Player editor on track change:",e),this.#l&&this.clearSelection(this.#l),this.state="playing",this.#h(),this.#l=e.id,t=this.getElement(e.id),!t)return;t.classList.add("playing");const a=t.querySelector(".title"),i=Math.floor(a.innerText.length/4);if(a.style["animation-duration"]=`${i}s`,"video"==t.dataset.type){const e=app.player.videoElement;t.appendChild(e)}return function(e,t){e.querySelector(".time").innerText=fileX.getDuration(t)}(t,e.duration),t}onTrackStop(){this.#h()}#h(){if(!this.#l)return;const e=this.getElement(this.#l);if(!e)return;e.classList.remove("playing");const t=e.querySelector("video");t&&dom.removeElement(t)}#p(e,t=!1){const a=e.name||e.filename||e.file.name,i=e.type?fileX.getType(e.type):function(e){const t=fileX.getExtension(e);return fileX.isVideo(t)?"video":"audio"}(a),s={id:e.id||a.hashCode(),title:fileX.getTitleFromMeta(e),desc:fileX.getDescriptionFromMeta(e),rating:e.rating,type:i};e.meta&&e.meta.duration&&(s.duration=e.meta.duration);const o=this.addItemTemplate("edior-player-track-item-file",s,t);return o.dataset.name=s.title.slice(0,8).toLowerCase(),o.dataset.type=i,o}#c(e){for(const t of e)this.#p(t,!0)}}function h(e,t){return e.dataset.rating==t.dataset.rating?e.dataset.name>t.dataset.name?1:-1:parseInt(t.dataset.rating)-parseInt(e.dataset.rating)}class u extends c{static id="radio";pages=new Map;#u;#m;#a;#t;#g;#y;constructor(e){super(e,u.id);const t=dom.renderTemplate("editor-player-radio",{name:"Nula",desc:"Classic jazz, soul",code:777});this.#g=UX.List.createMixin(t.querySelector('[role="chat"]')),this.container.appendChild(t),this.addPage("main",new UX.Page(t)),this.switchTo("main"),app.on("radiomsg",(e=>this.#f(e.detail)))}async open(e){if(this.#y==e)return;this.#y=e,this.toggleLoading(),console.debug("Open radio:",e);const t=this.switchTo("main");t.removeChilds();const a=app.ds("radio"),i=await delayResolve(a.get(e),1200);this.toggleLoading(),t.addTemplate("editor-player-radio",i)}load(){}onTabChange(e,t){let a=this.switchTo(e);a||("player"===e&&(a=this.#b()),this.addPage(e,a),this.switchTo(e))}onAction(...e){this.onEditorAction(...e)}onEditorAction(e,t,a){"send"===e&&this.#w(a)}onKeyPress(e,t){"Enter"==t&&this.#w(e)}#w(e){const t=e.inputValue;this.#k(t)}#k(e){console.debug("Radio editor chat:",e);const t={name:"Alice Freeman",own:!0,msg:e};this.#g.addItemTemplate("editor-contact-chat-message",t,!0),app.sendRoomMessage("radio",e,!1)}#b(){const e=dom.renderTemplate("editor-player-remote");this.container.appendChild(e);const t=e.querySelector('[role="tracks"]'),a=e.querySelector('[role="playlist"]');this.#m=UX.List.createMixin(t);const i=UX.List.createMixin(a);return this.#t=i.addGroup({name:"next",badge:"true",hidable:!0,count:!0}),this.#v(),new UX.Page(e)}#f(e){e.avatar=e.avatar||e.photo||"/ui/svg/contact.svg",this.#g.addItemTemplate("editor-contact-chat-message",e,!0)}async#v(){if(this.#u)return;const e=`ws://${location.host}:9084`;console.log("HOST:",e);const t=new WebSocket(e);t.onopen=e=>{console.debug("WS RADIO CONNECTION: connected"),t.send(JSON.stringify({method:"ls"})),t.send(JSON.stringify({method:"bind"}))},t.onmessage=e=>{const t=e.data,a=JSON.parse(t);console.debug("MSG received:",a);const{method:i,...s}=a;if("ls"==i)for(const e of s.tracks)console.debug("TRACK:",e),this.#m.addItemTemplate("edior-player-track-item-file",e);else switch(i){case"queue":this.#t.addTemplate("editor-player-sidebar-queue-item",s).dataset.id=s.id;break;case"onchange":{const e=s.id,t=this.#t.getElement(e);t&&dom.removeElement(t)}}},t.onclose=()=>{console.log("RADIO socket remote close"),this.#u=null},t.onerror=e=>{console.error("PUSH socket error",e),this.#u=null},this.#u=t}}Object.assign(u.prototype,UX.PageControllerMixin);const m={files:{title:"Media files",desc:"Play and share with friends your media files"},youtube:{title:"Youtube",desc:"Play and share with friends your favorite videos"},torrent:{title:"Torrents",desc:"Play and share with friends your media files"},radio:{title:"Radio",desc:"Listen online radio"}};class g extends App.Editor.Page{static#T={};static register(e){this.#T[e.id]=e}static id="player";#P;#C=[];#n=0;#S;#A;#E;#I;#x;get sidebar(){return this.#P}get dragOptions(){return{directory:!1,hover:!0,files:["audio","video","image"],items:["playlist"]}}set state(e){e!=this.#A&&(this.#A=e,this.container.setAttribute("state",e),this.container.querySelector('.header button[name="play"]').title="playing"==e?"Pause":"Play")}constructor(e){e||((e=dom.renderTemplate("editor-base-sidebar",{},"div","editor-player-header","editor-player-base",d.getTabs())).id="player-editor",e.classList.add("dark","player")),super(e),console.log("Creating player editor ...."),this.#q();const t=this.header,a=(t.icon,t.q(".progress"));app.player.wrapProgress(new y(a)),app.on("trackchange",(e=>this.#s(e.detail))),app.on("trackstop",(e=>this.#D(e.detail))),app.on("trackpause",(e=>this.#M(e.detail))),app.on("filesdropped",(e=>this.#O(e.detail)));const i=this.editorElement;this.#L(i),this.#C.push(t.button("play")),this.#C.push(t.button("prev")),this.#C.push(t.button("next")),this.state=app.player.isPlaying?"playing":"paused"}async open(e,...t){let a;this.#I=null,this.container.setAttribute("view",e),console.log("Player page open:",e);const i=this.header,s=i.icon,o=m[e];switch(this.#x=o,e){case"torrent":case"files":case"radio":i.title=o.title,i.desc=o.desc,s.name=e,this.#F(e);break;default:{const o=app.ds("playlist");a=t.shift(),a=a||e;let n=await o.get(a);i.title=n.display||n.name,i.desc=`${n.genre}, ${n.tracks.length} tracks`,s.name="playlist",this.#I=n,this.#F("files",n.tracks)}}}onAction(e,t,a){switch(e){case"next":app.player.playNext();break;case"prev":app.player.playPrev();break;case"play":"paused"==this.#A?app.player.resume():app.player.pause();break;case"share":app.share("playlist",this.#I)}}onFileDrop(e,t,a){console.log("Player editor on file drop:",e.length);const i=[],s=[],o=[];for(const t of e){const e=fileX.getExtension(t.name);fileX.isImage(e)?i.push(t):fileX.isMedia(e)?s.push(t):o.push(t)}if(s.length){this.active.onFilesDrop(s,i,o);const e=[],t=[];let n,r;for(const a of s)r=a.name.hashCode(),n=a.name,a.meta&&(n=a.meta.title||n,a.meta.album&&t.push(a.meta.album),delete a.meta),e.push({id:r,title:n,file:a});if(s.length>2){let o=a;if(s.length==t.length&&1==t.unique().length){o=t[0];const e={name:o,id:o.hashCode().toString(),type:"album",tracks:s.map((e=>({id:e.id||e.name.hashCode(),filename:e.name,size:e.size,title:e.meta&&e.meta.title?e.meta.title:e.name})))};i.length>0&&(i.sort(((e,t)=>e.size-t.size)),e.cover=i[0]),app.add("playlist",e,"new")}else app.executeCommand("add-new-playlist",e,o)}}}onTabChange(...e){this.active&&this.active.onTabChange(...e)}async onScrollY(e,t){if(this.active.more&&t-e<30&&!this.#S){this.#S=!0,this.toggleLoading();try{await sleep(1200),await this.active.load(!0)}catch(e){}finally{this.toggleLoading()}this.#S=!1}}async#F(e,...t){return console.log("Player OPEN:",e),this.switchTo(e),this.active||(this.#R(e),this.switchTo(e),await this.active.load()),this.#I&&t.unshift(this.#I),this.active.open(...t)}#X(e){console.debug("Openning radio:",e)}#R(e){const t=new(0,g.#T[e])(this.area);return this.addPage(e,t),t}#q(){const e=this.sidebarElement,t=new d(e);this.#P=t}#s(e){const t=this.active.onTrackChange(e);t&&app.editor.scrollTo(t),this.header.desc=fileX.getTitle(e),this.state="playing"}#D(){console.log("Editor Player: track stop"),this.#x&&(this.header.desc=this.#x.desc),this.state="paused",this.active.onTrackStop()}#M(){console.log("Editor Player: track pause"),this.state="paused"}#j({sec:e,total:t}){this.#E.update(e,t)}#O(e){console.log("Player on files dropped")}#L(e){e.querySelector('input[name="filter"]')}#N(e){const t=e.querySelector('input[name="magnet"]'),a=e.querySelector('button[name="download"]');let i;e.querySelector('button[name="stop"]').onclick=()=>{i&&app.cancelTorrent(i),t.disabled=!1,a.disabled=!1},a.onclick=async()=>{if(i=t.value,""==i)return void console.log("Cannot download empty torrent");t.disabled=!0,a.disabled=!0,console.log("Downloading magnet:",i);const e=await app.firebase.get("torrent",i);app.downloadTorrent(e.uri,{progress(){},done(){t.disabled=!1,a.disabled=!1}})}}}class y{#z;#U;constructor(e){this.#z=e.querySelector('input[type="range"]'),this.#U=e.querySelector("time"),this.#z.oninput=e=>app.player.seek(e.target.value)}update(e,t){this.#z.value=Math.round(e/t*100);let a=t-e;a<0&&(a=0),this.#U.innerText=fileX.getDuration(a)}pause(){this.#z.disabled=!0}resume(){this.#z.disabled=!1,dom.showElement(this.#U)}end(){this.#z.value=0,this.#z.disabled=!0,dom.hideElement(this.#U)}}g.register(p),g.register(u),App.Editor.register(g),App.Commands.register("add-new-playlist",((e=app.player.recent,t=null)=>{console.log("# Creating playlist:",e);const a={icon:"",desc:"Create a new playlist",reload:!0,onAdd(t){t.name=t.display.toLowerCase(),t.id=t.name.hashCode().toString();const a=e.filter((e=>!t.tracks.includes(e.id)));for(const e of a)e.filename=e.file.name,e.size=e.file.size,delete e.file;t.tracks=a,app.add("playlist",t,"new")}};a.info={tracks:e},t&&(a.display=t),app.openEditor("add","new","playlist",a)})),App.Commands.register("player-import-files",(async()=>{try{const e=await showOpenFilePicker({id:"media",multiple:!0,startIn:"music",excludeAcceptAllOption:!0,types:[{description:"Media files",accept:{"audio/*":[".mp3",".ogg",".flac"],"video/*":[".webm",".mkv",".avi"]}}]});app.editor.onImport(e)}catch(e){console.error("Failed to import files")}})),App.Commands.register("player-play-file",(e=>app.player.playFile(e))),App.Commands.register("player-queue-file",(e=>app.player.playFile(e,!0))),App.Commands.register("player-queue-rm",(e=>app.player.remove(e))),App.Commands.register("player-toggle-repeat",(()=>app.player.toggleRepeat())),App.Commands.register("player-toggle-shuffle",(()=>app.player.toggleShuffle()));const f=AddEditor.Fields;AddEditor.register("playlist",[f.string({name:"display",title:"Name",required:!0}),f.option({name:"genre",options:["Pop","Rock","Hip Hop","R&B","Electronic","Country","Jazz","Classic","Reggae","Metal","Blues","Folk","Soul","Dance","Punk"]}),f.list({name:"tracks",template:"editor-player-sidebar-playlist-file"})]);class b extends App.Sidebar.Page{static id="player";#B;#$;get icon(){return""}constructor(e="sidebar-player"){super(b.id,e),app.on("playlistadd",(e=>this.#G(e.detail,!0))),app.on("playlistrm",(e=>this.#J(e.detail)))}load(e){return this.#H()}async#H(){let e;this.#W(),this.#Y();const t={visible:100,badge:!0,draggable:!0,hide:!0,cmd:"open-playlist-player",item:"sidebar-player-item-playlist",name:"album",icon:"fa-compact-disc w3-text-purple"};e=this.addGroup(t),this.#B=e,t.name="playlist",t.icon="playlist w3-text-deep-orange",e=this.addGroup(t),this.#$=e;const a=app.ds("playlist"),i=await a.ls();for(const e of i)this.#G(e)}add(e,t){console.log("Sidebar (contact): adding",e,t)}#W(){const e=[{display:"Local files",id:"files",icon:"folder sm",cmd:"open-files-player"}];for(const t of e)this.addItemTemplate("sidebar-player-item",t)}async#Y(){const e=this.addGroup({name:"radio",icon:"fa-radio w3-text-red",visible:5,badge:!1,draggable:!0,item:"sidebar-radio-item",cmd:"open-radio-player",actions:[{name:"add",icon:"add",cmd:"find-radio"}]}),t=app.ds("radio"),a=await t.ls();console.debug("Loading radios",a);for(const t of a)e.add(t)}#G(e,t=!1){const a="album"==e.type?this.#B:this.#$;t&&a.getElement(e.id)||a.add(e)}#J(e){this.#$.delete(e)}static defaultSettings(){return{playlist:{visible:10,order:[]}}}}const w=b;class k extends App{constructor(){super(document.getElementById("app-page"))}createDatabase(){return new l}async setupDatabase(e){}async load(){console.log("APP: on load"),this.initDataSource(),this.startLifecycle(),await super.load(),this.sidebar.open("player","files"),this.openEditor("player","files")}initDataSource(){this.addDS(new App.DataSource.Database("playlist")),this.addDS(new App.DataSource.Database("radio"))}showHelp(){document.getElementById("modal-dialog").style.display="block"}async add(e,t,a="import"){const i=app.ds(e);let s,o=!1;if("string"==typeof t){if(s=t,!(t=await i.get(s)))return void console.error("Failed to",a,e,s)}else s=t.id;try{"import"===a?(t.remote=void 0,i.update(t,a)):o=!0;let s=["update","edit"].includes(a);o&&i&&await i.put(t,s),console.log("APP: add",e,t),super.add(e,t,s)}catch(t){console.error("APP: failed to add =>",e,t)}return t.id}}return Object.assign(App.prototype,a,s),App.Sidebar.register(w),t})()));